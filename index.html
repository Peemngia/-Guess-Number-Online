<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üéÆ Guess Number Online - Lobby</title>

<style>
body{
  margin:0;
  min-height:100vh;
  background:#0b0b0b;
  color:white;
  font-family:sans-serif;
  display:flex;
  justify-content:center;
  align-items:center;
}
.card{
  width:95%;
  max-width:450px;
  background:#111;
  padding:20px;
  border-radius:16px;
  box-shadow:0 0 25px #00ffff55;
}
h2{color:#00ffff;margin-top:0}
input,button{
  width:100%;
  padding:12px;
  margin-top:8px;
  border:none;
  border-radius:10px;
  font-size:16px;
}
button{font-weight:bold;cursor:pointer}
.green{background:#00ff88;color:#000}
.blue{background:#00ffff;color:#000}
.red{background:#ff4444;color:#fff} 
.box{
  background:#000;
  padding:10px;
  border-radius:10px;
  margin-top:10px;
  max-height:120px;
  overflow:auto;
}
hr{border:0;border-top:1px solid #333;margin:15px 0}
</style>
</head>

<body>
<div class="card">

<h2>üé≤ Guess Number Online</h2>

<input id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô">
<input id="room" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á">
<input id="pass" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á">

<button id="createBtn" class="green">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á</button>
<button id="joinBtn" class="blue">‚û°Ô∏è ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á</button>

<hr>

<b>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</b>
<input id="playerSearchInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤">
<button id="searchPlayerBtn" class="blue">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</button>
<div id="searchResults" class="box" style="margin-top: 5px;"></div>
<hr>

<b>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡πâ‡∏≠‡∏á</b>
<input id="roomSearchInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤">
<button id="searchRoomBtn" class="blue">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡πâ‡∏≠‡∏á</button>
<div id="roomSearchResults" class="box" style="margin-top: 5px;"></div>

</div>

<audio id="clickSound" src="computer-mouse-click-352734.mp3" preload="auto"></audio> 

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, set, get, push, update, remove }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

// *** Firebase Config ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ***
const firebaseConfig = {
  apiKey: "AIzaSyDRlB6q1NJeSnO4JsLQcUHr28XGKo573sk",
  authDomain: "peem-dc962.firebaseapp.com",
  databaseURL: "https://peem-dc962-default-rtdb.firebaseio.com",
  projectId: "peem-dc962",
  storageBucket: "peem-dc962.firebasestorage.app",
  messagingSenderId: "1021248731842",
  appId: "1:1021248731842:web:155602dc9d8b2b2b78595b",
  measurementId: "G-WLK08GX4EL"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Sound Function
function playClick() {
    const audio = document.getElementById("clickSound");
    audio.currentTime = 0;
    audio.play().catch(e => console.log("Sound play failed:", e)); 
}

document.addEventListener("DOMContentLoaded", () => {

const nameI  = document.getElementById("name");
const roomI  = document.getElementById("room");
const passI  = document.getElementById("pass");
const createBtn = document.getElementById("createBtn");
const joinBtn   = document.getElementById("joinBtn");
const playerSearchInput = document.getElementById("playerSearchInput"); 
const searchPlayerBtn = document.getElementById("searchPlayerBtn");   
const searchResultsDiv = document.getElementById("searchResults");   
const roomSearchInput = document.getElementById("roomSearchInput"); 
const searchRoomBtn = document.getElementById("searchRoomBtn");   
const roomSearchResultsDiv = document.getElementById("roomSearchResults"); 

function checkUrlForInvite(){
    const urlParams = new URLSearchParams(window.location.search);
    const invitedRoom = urlParams.get('room');
    const kickedStatus = urlParams.get('kicked');
    const exitStatus = urlParams.get('exit');

    if(invitedRoom){
        roomI.value = invitedRoom; 
        alert(`‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡πÄ‡∏ä‡∏¥‡∏ç‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á: ${invitedRoom} ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á`);
    }
    if(kickedStatus === 'true'){
        alert("‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á!");
    }
    if(exitStatus === 'true'){
        alert("‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß");
    }
}
checkUrlForInvite();

function goToGame(playerName, roomName){
    window.location.href = `game.html?room=${roomName}&player=${playerName}`;
}

/* ‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á */
async function createRoom(){
  playClick(); 
  const player = nameI.value.trim();
  const room   = roomI.value.trim();
  const pw = passI.value.trim();

  if(!player || !room || !pw)
    return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡πâ‡∏≠‡∏á ‡∏£‡∏´‡∏±‡∏™ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏î‡∏¥‡πÑ‡∏≠‡πâ‡πÄ‡∏´‡∏µ‡πâ‡∏¢");

  const roomRef = ref(db,"rooms/"+room);
  
  try {
    const snap = await get(roomRef);

    if(snap.exists())
      return alert("‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");

    const answer = Math.floor(Math.random()*100)+1; 

    await set(roomRef,{
      password: pw,
      answer: answer,
      players:{ [player]: true },
      winStats: {},
      guessedNumbers: {},
      host: player 
    });
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin Kick)
    await set(ref(db, "playersOnline/" + player), { room: room });

    goToGame(player, room);

  } catch(error) {
    console.error("Firebase Error (Create Room):", error);
    alert("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firebase Rules ‡∏´‡∏£‡∏∑‡∏≠ Config!");
  }
}

/* ‚û°Ô∏è ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á */
async function joinRoom(){
  playClick(); 
  const player = nameI.value.trim();
  const room   = roomI.value.trim();
  const pw = passI.value.trim();

  if(!player || !room || !pw)
    return alert("‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏¥");

  const roomRef = ref(db,"rooms/"+room);
  
  try {
    const snap = await get(roomRef);

    if(!snap.exists())
      return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ");

    if(snap.val().password !== pw)
      return alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î‡πÑ‡∏≠‡πâ‡∏™‡∏±‡∏™");

    if(snap.val().players?.[player])
      return alert("‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥‡πÄ‡∏ß‡πâ‡∏¢");

    await set(ref(db,"rooms/"+room+"/players/"+player), true);
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin Kick)
    await set(ref(db, "playersOnline/" + player), { room: room });

    goToGame(player, room);
    
  } catch(error) {
    console.error("Firebase Error (Join Room):", error);
    alert("‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firebase Rules ‡∏´‡∏£‡∏∑‡∏≠ Config!");
  }
}

/* üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô */
async function searchPlayer(){
    playClick(); 
    const searchName = playerSearchInput.value.trim().toLowerCase();
    searchResultsDiv.innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...";

    if (!searchName) {
        searchResultsDiv.innerHTML = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤";
        return;
    }
    
    try {
        const roomsRef = ref(db, "rooms");
        const snapshot = await get(roomsRef);
        
        let found = false;
        let resultsHTML = '';
        
        if (snapshot.exists()) {
            snapshot.forEach(roomSnap => {
                const roomKey = roomSnap.key;
                const roomData = roomSnap.val();
                const players = roomData.players || {};
                const host = roomData.host || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';

                for (const pName in players) {
                    if (pName.toLowerCase().includes(searchName)) { 
                        resultsHTML += `<div>‚úÖ ‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô <b>${pName}</b> ‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á <b>${roomKey}</b> (‡∏´‡∏±‡∏ß‡∏´‡πâ‡∏≠‡∏á: ${host})</div>`;
                        found = true;
                        return; 
                    }
                }
            });
        }
        
        if (!found) {
            resultsHTML = '<div>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÉ‡∏î‡πÜ</div>';
        }
        
        searchResultsDiv.innerHTML = resultsHTML;

    } catch (error) {
        console.error("Firebase Error (Search Player):", error);
        searchResultsDiv.innerHTML = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
    }
}

/* üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡πâ‡∏≠‡∏á */
async function searchRoom(){
    playClick(); 
    const searchRoomName = roomSearchInput.value.trim().toLowerCase();
    roomSearchResultsDiv.innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...";

    if (!searchRoomName) {
        roomSearchResultsDiv.innerHTML = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤";
        return;
    }
    
    try {
        const roomsRef = ref(db, "rooms");
        const snapshot = await get(roomsRef);
        
        let found = false;
        let resultsHTML = '';
        
        if (snapshot.exists()) {
            snapshot.forEach(roomSnap => {
                const roomKey = roomSnap.key;
                if (roomKey.toLowerCase().includes(searchRoomName)) { 
                    const roomData = roomSnap.val();
                    const players = roomData.players || {};
                    const host = roomData.host || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏£‡∏∞‡∏ö‡∏∏';
                    const playerCount = Object.keys(players).length;
                    const passwordStatus = roomData.password ? 'üîë ‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™' : 'üîì ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™';

                    resultsHTML += `<div>üì¶ ‡∏´‡πâ‡∏≠‡∏á <b>${roomKey}</b> ‚Äî üë§ ${playerCount} ‡∏Ñ‡∏ô ‚Äî ${passwordStatus} ‚Äî ‡∏´‡∏±‡∏ß‡∏´‡πâ‡∏≠‡∏á: ${host}</div>`;
                    found = true;
                }
            });
        }
        
        if (!found) {
            resultsHTML = '<div>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏≠‡∏¢‡∏π‡πà</div>';
        }
        
        roomSearchResultsDiv.innerHTML = resultsHTML;

    } catch (error) {
        console.error("Firebase Error (Search Room):", error);
        roomSearchResultsDiv.innerHTML = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
    }
}


/* üîò ‡∏ú‡∏π‡∏Å‡∏õ‡∏∏‡πà‡∏° */
createBtn.onclick = createRoom;
joinBtn.onclick   = joinRoom;
searchPlayerBtn.onclick = searchPlayer; 
searchRoomBtn.onclick = searchRoom; 

});
</script>

</body>
</html>