<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üéÆ Guess Number Online - Game</title>

<style>
body{
  margin:0;
  min-height:100vh;
  background:#0b0b0b;
  color:white;
  font-family:sans-serif;
  display:flex;
  justify-content:center;
  align-items:center;
}
.card{
  width:95%;
  max-width:450px;
  background:#111;
  padding:20px;
  border-radius:16px;
  box-shadow:0 0 25px #00ffff55;
}
h2{color:#00ffff;margin-top:0}
input,button{
  width:100%;
  padding:12px;
  margin-top:8px;
  border:none;
  border-radius:10px;
  font-size:16px;
  transition: all 0.15s ease;
}
button{font-weight:bold;cursor:pointer}
.green{background:#00ff88;color:#000}
.blue{background:#00ffff;color:#000}
.red{background:#ff4444;color:#fff} 
.box{
  background:#000;
  padding:10px;
  border-radius:10px;
  margin-top:10px;
  max-height:120px;
  overflow:auto;
}
hr{border:0;border-top:1px solid #333;margin:15px 0}

/* Hover and Active Effects */
button:not([disabled]):hover {
    filter: brightness(1.15); 
    transform: translateY(-1px);
}
button:not([disabled]):active {
    filter: brightness(0.9);
    transform: translateY(1px);
    box-shadow: none;
}
button[disabled] {
    cursor: not-allowed;
    opacity: 0.6;
}
/* END Effects */

#inviteBtn{
    background: #4444ff;
    color: white;
    margin-bottom: 5px;
}
#exitBtn {
    background: #ffaa00; 
    color: #000;
    margin-bottom: 5px;
}
#playerCount {
    text-align: right;
    font-size: 14px;
    opacity: 0.8;
    margin-top: -10px;
}
#result {
    font-weight: bold;
    color: #ffaa00;
    margin: 10px 0;
}
#newGameBtn {
    background: #20b2aa;
    color: white;
    display: none;
}
#loading {
    text-align: center;
    padding: 50px 0;
    font-size: 1.2em;
    color: #00ffff;
}
</style>
</head>

<body>
<div class="card">

<h2>üéÆ Game: <span id="roomNameDisplay">...</span></h2>

<div id="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡πâ‡∏≠‡∏á...</div>

<div id="game" style="display:none;">
  <div id="playerCount">üë§ 0 ‡∏Ñ‡∏ô</div> 
  <p id="guessInfo">‡∏ó‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç 1 - 100</p>
  <input id="guess" type="number">
  <button id="guessBtn">‡πÄ‡∏î‡∏≤</button>
  <div id="result"></div>
  
  <button id="inviteBtn">üîó ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏ä‡∏¥‡∏ç</button>
  <button id="exitBtn" class="red">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á</button>
  <button id="newGameBtn">üéâ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà</button>
  <hr>

  <b>üí¨ ‡πÅ‡∏ä‡∏ó</b>
  <div class="box" id="chat"></div>
  <input id="msg">
  <button id="sendBtn">‡∏™‡πà‡∏á</button>

  <hr>

  <b>üë• ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á</b>
  <div class="box" id="playerList"></div> 
  <hr>

  <b>üèÜ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≠‡∏ö (2 ‡πÉ‡∏ô 3 ‡∏ä‡∏ô‡∏∞)</b>
  <div class="box" id="winScore"></div>
  <hr>
  <b>üèÖ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</b>
  <div class="box" id="score"></div>
</div>

</div>

<audio id="clickSound" src="computer-mouse-click-352734.mp3" preload="auto"></audio> 
<audio id="guessSound" src="guess.mp3" preload="auto"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
import { getDatabase, ref, set, get, push, onValue, update, remove }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

// *** Firebase Config ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏ñ‡∏π‡∏Å‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß) ***
const firebaseConfig = {
  apiKey: "AIzaSyDRlB6q1NJeSnO4JsLQcUHr28XGKo573sk",
  authDomain: "peem-dc962.firebaseapp.com",
  databaseURL: "https://peem-dc962-default-rtdb.firebaseio.com",
  projectId: "peem-dc962",
  storageBucket: "peem-dc962.firebasestorage.app",
  messagingSenderId: "1021248731842",
  appId: "1:1021248731842:web:155602dc9d8b2b2b78595b",
  measurementId: "G-WLK08GX4EL"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getDatabase(app);

// *** ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ‡πÅ‡∏•‡∏∞ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ä‡∏ô‡∏∞ ***
const MAX_GUESSES = 10; 
const ROUNDS_TO_WIN = 2; 

// Sound Functions
function playClick() {
    document.getElementById("clickSound").currentTime = 0;
    document.getElementById("clickSound").play().catch(e => console.log("Sound play failed:", e));
}
function playGuessSound() {
    document.getElementById("guessSound").currentTime = 0;
    document.getElementById("guessSound").play().catch(e => console.log("Sound play failed:", e));
}


document.addEventListener("DOMContentLoaded", () => {

let player="", room="", hasGuessed=false, guessCount=0, minRange=1, maxRange=100;

// DOM Elements
const gameDiv   = document.getElementById("game");
const loadingDiv = document.getElementById("loading");
const roomNameDisplay = document.getElementById("roomNameDisplay");
const result = document.getElementById("result"); 
const guessI = document.getElementById("guess");
const guessBtn = document.getElementById("guessBtn");
const chat = document.getElementById("chat");
const msgI = document.getElementById("msg");
const sendBtn = document.getElementById("sendBtn");
const score = document.getElementById("score");
const winScoreDiv = document.getElementById("winScore");
const inviteBtn = document.getElementById("inviteBtn"); 
const exitBtn = document.getElementById("exitBtn");
const playerCountDiv = document.getElementById("playerCount");
const guessInfoDiv = document.getElementById("guessInfo");
const newGameBtn = document.getElementById("newGameBtn");
const playerListDiv = document.getElementById("playerList");


function getUrlParams(){
    const urlParams = new URLSearchParams(window.location.search);
    const roomParam = urlParams.get('room');
    const playerParam = urlParams.get('player');

    if(!roomParam || !playerParam){
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ Lobby");
        window.location.href = `index.html`;
        return false;
    }

    room = roomParam;
    player = playerParam;
    roomNameDisplay.innerText = room;
    loadingDiv.style.display = 'none';
    gameDiv.style.display = 'block';

    get(ref(db, `rooms/${room}/players/${player}`)).then(snap => {
        if(!snap.exists()){
             alert("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
             window.location.href = `index.html`;
             return;
        }
        resetLocalState();
        listen();
    });
}
getUrlParams();

function resetLocalState(){
    hasGuessed=false;
    guessCount=0;
    minRange=1;
    maxRange=100;
    result.innerText = "‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏∏‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß!";
    updateGuessInfo();
    newGameBtn.style.display = "none";
}

async function resetFullGame(){
    playClick();
    if(!confirm("‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏•‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≠‡∏ö‡∏ä‡∏ô‡∏∞)?")) return;
    
    const roomRef = ref(db,"rooms/"+room);
    const hostName = (await get(ref(db, `rooms/${room}/host`))).val();
    
    if(player !== hostName) {
        return alert("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏´‡∏±‡∏ß‡∏´‡πâ‡∏≠‡∏á! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ô‡∏∞");
    }

    await remove(ref(db, `rooms/${room}/winStats`));
    
    const newAnswer = Math.floor(Math.random()*100)+1;
    await update(roomRef, {
        answer: newAnswer,
        score: null, 
        guessedNumbers: null 
    });
    
    push(ref(db,"rooms/"+room+"/chat"),{n:"SERVER",m:"üéä ‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß! ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏ô‡∏∞‡∏ñ‡∏π‡∏Å‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï"});
}

async function exitGame(isKicked = false){
  
  if(room && player){
    await remove(ref(db, `rooms/${room}/players/${player}`));
    await remove(ref(db, `playersOnline/${player}`));
  }
  
  let redirectUrl = `index.html`;
  if(isKicked){
      redirectUrl += `?kicked=true`;
  } else {
      redirectUrl += `?exit=true`;
  }

  window.history.replaceState({}, document.title, window.location.pathname);
  
  window.location.href = redirectUrl;
}

async function handleKick(kickedPlayerName){
    playClick();
    if (player !== (await get(ref(db, `rooms/${room}/host`))).val()) {
        return alert("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏´‡∏±‡∏ß‡∏´‡πâ‡∏≠‡∏á! ‡πÄ‡∏ï‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ô‡∏∞");
    }
    
    if(kickedPlayerName === player) {
        return alert("‡∏à‡∏∞‡πÄ‡∏ï‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ó‡∏≥‡πÑ‡∏°");
    }

    if (confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏∞ ${kickedPlayerName} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)){
        await remove(ref(db, `rooms/${room}/players/${kickedPlayerName}`));
        await remove(ref(db, `playersOnline/${kickedPlayerName}`));

        push(ref(db,"rooms/"+room+"/chat"),{n:"SERVER",m:`‡∏´‡∏±‡∏ß‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏∞ ${kickedPlayerName} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß!`});
    }
}
window.handleKick = handleKick; 


/* üéØ ‡πÄ‡∏î‡∏≤‡πÄ‡∏•‡∏Ç */
async function guessNum(){
  playGuessSound(); 
  
  if(hasGuessed) return alert("‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏î‡∏≤‡∏ñ‡∏π‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß! ‡∏£‡∏≠‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏∏‡πà‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏•‡∏Ç");
  
  const g = Number(guessI.value);

  if (isNaN(g) || g < 1 || g > 100) return alert("‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç 1 - 100 ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏î‡∏¥");
  
  const roomRef = ref(db,"rooms/"+room);
  const roomSnap = await get(roomRef);
  const guessedNumbers = roomSnap.val().guessedNumbers || {};

  if (guessedNumbers[g]) {
      return alert(`‡πÄ‡∏•‡∏Ç ${g} ‡∏ñ‡∏π‡∏Å‡πÄ‡∏î‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏î‡∏≤‡πÄ‡∏•‡∏Ç‡∏≠‡∏∑‡πà‡∏ô`);
  }
  
  if(guessCount >= MAX_GUESSES){
      return alert(`‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏î‡∏≤‡∏Ñ‡∏£‡∏ö ${MAX_GUESSES} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß! ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Å‡∏°‡∏´‡∏ô‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏∏‡πà‡∏°`);
  }

  guessCount++; 

  await update(roomRef, { 
      ['guessedNumbers/' + g]: true 
  });
  
  const a = roomSnap.val().answer; 
  let message = ""; 

  if(g > a){
    result.innerText="‡∏°‡∏≤‡∏Å‡πÑ‡∏õ";
    maxRange = Math.min(maxRange, g - 1);
    message = `‡πÄ‡∏î‡∏≤ ${g} ‚û°Ô∏è [‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤]`;
  }
  else if(g < a){
    result.innerText="‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ";
    minRange = Math.max(minRange, g + 1);
    message = `‡πÄ‡∏î‡∏≤ ${g} ‚¨ÖÔ∏è [‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤]`;
  }
  else{
    const winStatsRef = ref(db,`rooms/${room}/winStats/${player}`);
    
    await set(ref(db,"rooms/"+room+"/score/"+player), Date.now()%100000);

    const currentWins = (await get(winStatsRef)).val() || 0;
    const newWins = currentWins + 1;
    await set(winStatsRef, newWins);

    result.innerText=`‡∏ñ‡∏π‡∏Å‡πÅ‡∏•‡πâ‡∏ß üéâ (‡πÉ‡∏ä‡πâ‡πÑ‡∏õ ${guessCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)`;
    hasGuessed = true; 
    
    if(newWins >= ROUNDS_TO_WIN){
        message = `üëë ‡∏ä‡∏ô‡∏∞‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${newWins} ‡∏£‡∏≠‡∏ö! ‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß! üèÜ`;
        push(ref(db,"rooms/"+room+"/chat"),{n:"SERVER",m:`${player} ${message}`});
        
        newGameBtn.style.display = "block";
        guessBtn.disabled = true;
        guessI.disabled = true;
        result.innerText = `üëë ${player} ‡∏ä‡∏ô‡∏∞‡πÄ‡∏Å‡∏°! (${newWins}/${ROUNDS_TO_WIN} ‡∏£‡∏≠‡∏ö)`;
        
    } else {
        const newAnswer = Math.floor(Math.random()*100)+1; 
        
        await update(roomRef, {
            answer: newAnswer,
            score: null,
            guessedNumbers: null 
        });
        
        message = `‡∏ä‡∏ô‡∏∞‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ (${newWins}/${ROUNDS_TO_WIN}) - ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏•‡∏Ç‡∏™‡∏∏‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß!`;
        push(ref(db,"rooms/"+room+"/chat"),{n:"SERVER",m:`${player} ${message}`});
        
        resetLocalState();
        result.innerText = `‡∏ñ‡∏π‡∏Å‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö ${newWins + 1}`;
    }
  }

  if (message && !hasGuessed) {
     push(ref(db,"rooms/"+room+"/chat"),{n:player,m: message});
  }

  updateGuessInfo();
  guessI.value = "";
}

function updateGuessInfo(){
    const remaining = MAX_GUESSES - guessCount;
    guessInfoDiv.innerHTML = `‡∏ó‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç <b>${minRange}</b> ‡∏ñ‡∏∂‡∏á <b>${maxRange}</b><br> (${remaining > 0 ? remaining : 0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠)`;
    
    const isDisabled = hasGuessed || guessCount >= MAX_GUESSES || newGameBtn.style.display !== "none";
    
    if(guessCount >= MAX_GUESSES && !hasGuessed){
        guessInfoDiv.innerHTML += `<br><span style="color:#ff4444;">‡∏´‡∏°‡∏î‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏î‡∏≤‡πÅ‡∏•‡πâ‡∏ß!</span>`;
    } else if (hasGuessed && newGameBtn.style.display === "none") {
        guessInfoDiv.innerHTML = `‚úÖ ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏î‡∏≤‡∏ñ‡∏π‡∏Å‡πÅ‡∏•‡πâ‡∏ß! ‡∏£‡∏≠‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏∏‡πà‡∏°...`;
    } else if (newGameBtn.style.display !== "none") {
        guessInfoDiv.innerHTML = `‚úÖ ‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß!`;
    } 

    guessBtn.disabled = isDisabled;
    guessI.disabled = isDisabled;
}

function sendMsg(){
  playClick(); 
  const m = msgI.value.trim();
  if(!m) return;
  push(ref(db,"rooms/"+room+"/chat"),{n:player,m});
  msgI.value="";
}

function copyInviteLink(){
    playClick(); 
    const link = `https://${window.location.host}/index.html?room=${room}`;

    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(link)
            .then(() => alert(`‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏ä‡∏¥‡∏ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${link}`))
            .catch(err => alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ: ' + err));
    } else {
        alert("‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡∏à‡∏≤‡∏Å URL");
    }
}


/* üì° ‡∏ü‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */
function listen(){
  // 1. ‡∏ü‡∏±‡∏á‡πÅ‡∏ä‡∏ó
  onValue(ref(db,"rooms/"+room+"/chat"), snap=>{
    chat.innerHTML="";
    let messages = [];
    snap?.forEach(c=>{
      messages.push(`<div><b>${c.val().n}</b>: ${c.val().m}</div>`);
    });
    chat.innerHTML = messages.join("");
    chat.scrollTop = chat.scrollHeight;
  });

  // 2. ‡∏ü‡∏±‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ (score)
  onValue(ref(db,"rooms/"+room+"/score"), snap=>{
    if(!snap.exists()){
      if(gameDiv.style.display==="block") {
        resetLocalState();
      }
      return;
    }
    
    score.innerHTML="";
    let scores = [];
    snap?.forEach(s=>{
      scores.push({name: s.key, score: s.val()});
    });
    scores.sort((a,b) => a.score - b.score);
    
    scores.forEach(s => {
      score.innerHTML+=`<div>üèÜ ${s.name}: ${s.score}</div>`;
    });
  });

  // 3. ‡∏ü‡∏±‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≠‡∏ö‡∏ä‡∏ô‡∏∞ (winStats)
  onValue(ref(db,"rooms/"+room+"/winStats"), snap=>{
    winScoreDiv.innerHTML="";
    if(!snap.exists()) {
        winScoreDiv.innerHTML = '<div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏ä‡∏ô‡∏∞‡∏£‡∏≠‡∏ö</div>';
        return;
    }
    
    let winStats = [];
    let isGameOver = false;

    snap?.forEach(s=>{
      const playerName = s.key;
      const wins = s.val();
      winStats.push(`<div>${playerName}: ${wins}/${ROUNDS_TO_WIN} ‡∏£‡∏≠‡∏ö</div>`);
      if(wins >= ROUNDS_TO_WIN) {
          isGameOver = true;
      }
    });

    winScoreDiv.innerHTML = winStats.join("");
    
    if(isGameOver) {
        newGameBtn.style.display = "block";
        guessBtn.disabled = true;
        guessI.disabled = true;
        result.innerText = `üëë ‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß! ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞ ${ROUNDS_TO_WIN} ‡∏£‡∏≠‡∏ö!`;
        guessInfoDiv.innerHTML = `‚úÖ ‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß!`;
    } else {
        if(gameDiv.style.display === "block" && !hasGuessed) {
            newGameBtn.style.display = "none";
        }
    }
  });


  // 4. ‡∏ü‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏ï‡∏∞
  onValue(ref(db,"rooms/"+room), async snap=>{
    if(!snap.exists()){
        exitGame(true);
        return;
    }

    const roomData = snap.val();
    const playersObj = roomData?.players || {};
    const hostName = roomData?.host || "";
    const isHost = player === hostName;
    const count = Object.keys(playersObj).length;
    
    playerCountDiv.innerText = `üë§ ${count} ‡∏Ñ‡∏ô`;
    
    let playerListHTML = "";
    let isStillInRoom = false;
    for (const pName in playersObj) {
        let kickButton = '';
        if (isHost && pName !== player) {
            kickButton = `<button style="background:#ff4444; color:white; padding: 3px 6px; border-radius: 5px; font-size: 12px; margin-left: 10px;" onclick="window.handleKick('${pName}')">‡πÄ‡∏ï‡∏∞</button>`;
        }
        
        if (pName === player) isStillInRoom = true;

        let hostTag = pName === hostName ? ' üëë (‡∏´‡∏±‡∏ß‡∏´‡πâ‡∏≠‡∏á)' : '';
        let selfTag = pName === player ? ' (‡∏Ñ‡∏∏‡∏ì)' : '';

        playerListHTML += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 5px 0;"><span>${pName}${hostTag}${selfTag}</span>${kickButton}</div>`;
    }
    playerListDiv.innerHTML = playerListHTML;

    if (!isStillInRoom && gameDiv.style.display==="block") {
      exitGame(true);
    }
  });
}

/* üîò ‡∏ú‡∏π‡∏Å‡∏õ‡∏∏‡πà‡∏° */
guessBtn.onclick  = guessNum;
sendBtn.onclick   = sendMsg;
inviteBtn.onclick = copyInviteLink;
exitBtn.onclick = () => {
    playClick(); 
    exitGame(false);
};
newGameBtn.onclick = resetFullGame;

});
</script>

</body>
</html>
